<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Temperature Dashboard</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.plot.ly/plotly-3.1.0.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-locale-pt-br-latest.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <style>
        #app {
            max-width: 900px;
            margin: auto;
            padding: 20px;
        }

        #plot {
            width: 100%;
            height: 500px;
        }
    </style>
</head>

<body>
    <div id="app">
        <h1>Monitor de temperaturas</h1>
        <div id="plot"></div>
    </div>

    <script>
        const { createApp, ref, onMounted, reactive } = Vue;

        createApp({
            setup() {
                const dataSeries = reactive({}); // { endereco: { x: [], y: [] } }
                const userLocale = navigator.language || 'en-US';


                function localDateToFakeUTC(d) {
                    // Create a new Date object where the UTC time is the local time
                    return new Date(d);
                }




                function formatDateForHover(datetimeStr) {
                    const dt = new Date(datetimeStr + "Z");
                    return dt.toLocaleString(userLocale);
                }


                // Initialize Plotly plot
                function plotData() {
                    Plotly.setPlotConfig({ locale: 'pt' });
                    const traces = Object.keys(dataSeries).map(endereco => ({
                        x: dataSeries[endereco].x,
                        y: dataSeries[endereco].y,
                        mode: 'lines',
                        name: endereco,
                        hovertemplate: '%{y}°C<br>%{x}',
                    }));


                    Plotly.react('plot', traces, {
                        title: 'Temperatura',
                        uirevision: 'true',
                        xaxis: {
                            title: 'Hora',
                            type: 'date',
                        },
                        yaxis: { title: 'Temperature (°C)' },
                    });
                }

                // Load initial data via HTTP
                async function fetchInitialData() {
                    try {
                        const res = await fetch(`https://${window.location.host}/dados`);
                        const json = await res.json();


                        json.forEach(sensor => {
                            dataSeries[sensor.endereco] = {
                                x: sensor.data.slice().map(localDateToFakeUTC),
                                y: sensor.temperatura.slice()
                            };
                        });

                        plotData();
                    } catch (err) {
                        console.error('Error fetching initial data:', err);
                    }
                }

                // WebSocket to receive new data
                function setupWebSocket() {
                    const host = '74101a5cd6e04a08a2d360bb58565bea.s1.eu.hivemq.cloud';
                    const clientId = `client_${Math.random().toString(16).substr(2, 8)}`;
                    const username = '{{hivemq_user}}';
                    const password = '{{hivemq_pass}}';

                    const cliente = mqtt.connect(`wss://${host}:8884/mqtt`, {
                        clientId: clientId,
                        username: username,
                        password: password,
                    });

                    // Handle connection events
                    cliente.on('connect', () => {
                        cliente.subscribe('/chbr_topic'); // Replace with your topic
                    });



                    cliente.on('message', (topic, message) => {
                        const msgs = JSON.parse(message.toString());

                        for (endereco of Object.keys(msgs)) {
                            const temperatura = msgs[endereco];

                            if (!dataSeries[endereco]) {
                                dataSeries[endereco] = { x: [], y: [] };
                            }

                            if (dataSeries[endereco].x.length > 2) {
                                const qdeTemperaturas = dataSeries[endereco].y.length;
                                const penultimaTemperatura = dataSeries[endereco].y[qdeTemperaturas - 2];
                                const ultimaTemperatura = dataSeries[endereco].y[qdeTemperaturas - 1];
                                if (temperatura == penultimaTemperatura && temperatura == ultimaTemperatura) {
                                    dataSeries[endereco].x = [...dataSeries[endereco].x.slice(0, -1), new Date()]

                                } else {
                                    dataSeries[endereco].y.push(temperatura);
                                    dataSeries[endereco].x = [...dataSeries[endereco].x, new Date()];
                                }
                            } else {
                                dataSeries[endereco].y.push(temperatura);
                                dataSeries[endereco].x = [...dataSeries[endereco].x, new Date()];
                            }

                            if (dataSeries[endereco].length > 1000) {
                                dataSeries[endereco].x.splice(0, 1);
                                dataSeries[endereco].y.splice(0, 1);
                            }
                        }
                        plotData();
                    })




                }


                onMounted(() => {
                    Plotly.setPlotConfig({ locale: 'pt-br' });
                    fetchInitialData();
                    setupWebSocket();
                });

                return { dataSeries };
            }

        }).mount('#app');
    </script>
</body>

</html>